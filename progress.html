<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyBuddy - Progress</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <!-- Confetti.js -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #2a0645, #6b21a8);
            color: #e2e8f0;
            padding-bottom: 50px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .navbar {
            background: rgba(30, 10, 60, 0.4) !important;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0 0 12px 12px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        .navbar-brand, .nav-link {
            color: #e2e8f0 !important;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: color 0.3s, transform 0.3s;
        }
        .nav-link:hover {
            color: #60a5fa !important;
            transform: scale(1.05);
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='%2360a5fa' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        .container {
            max-width: 1200px;
            margin: 90px auto 30px;
            padding: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeIn 0.5s ease;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        }
        .card h5 {
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #60a5fa;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .timer {
            font-size: 1.6rem;
            font-weight: 700;
            color: #facc15;
        }
        .session-timer {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transition: background-color 0.3s, transform 0.3s;
        }
        .session-timer:hover {
            transform: scale(1.05);
        }
        .session-timer.green { background: rgba(34, 197, 94, 0.3); }
        .session-timer.yellow { background: rgba(234, 179, 8, 0.3); }
        .session-timer.red { background: rgba(239, 68, 68, 0.3); }
        .chatbot-panel {
            position: fixed;
            top: 70px;
            right: -300px;
            width: 300px;
            height: calc(100vh - 130px);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px 0 0 12px;
            box-shadow: -4px 0 16px rgba(0, 0, 0, 0.3);
            z-index: 998;
            transition: right 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .chatbot-panel.open {
            right: 0;
        }
        .chatbot-header {
            padding: 12px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px 0 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .chatbot-header h5 {
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #60a5fa;
        }
        .chatbot-header .close-btn, .chatbot-header .clear-btn {
            background: transparent;
            border: none;
            color: #e2e8f0;
            font-size: 1.3rem;
            transition: color 0.3s, transform 0.3s;
        }
        .chatbot-header .close-btn:hover, .chatbot-header .clear-btn:hover {
            color: #ef4444;
            transform: scale(1.1);
        }
        .chatbot-body {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chatbot-message {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 14px;
            border-radius: 10px;
            max-width: 80%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s ease;
        }
        .chatbot-message.user {
            background: rgba(167, 139, 250, 0.3);
            align-self: flex-end;
        }
        .chatbot-suggestions {
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
        }
        .chatbot-suggestion {
            background: linear-gradient(45deg, #a78bfa, #7c3aed);
            border: none;
            border-radius: 16px;
            padding: 6px 12px;
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
            animation: slideIn 0.5s ease;
        }
        .chatbot-suggestion:hover {
            transform: scale(1.05);
            background: linear-gradient(45deg, #7c3aed, #a78bfa);
        }
        .chatbot-footer {
            padding: 12px;
            background: rgba(255, 255, 255, 0.15);
        }
        .chatbot-footer input {
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #e2e8f0;
        }
        .chatbot-footer input::placeholder {
            color: #94a3b8;
        }
        .chatbot-footer .btn {
            background: linear-gradient(45deg, #a78bfa, #7c3aed);
            border: none;
            border-radius: 20px;
            transition: transform 0.3s;
        }
        .chatbot-footer .btn:hover {
            transform: scale(1.05);
            background: linear-gradient(45deg, #7c3aed, #a78bfa);
        }
        .chatbot-toggle {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            animation: pulse 1.5s infinite;
            transition: opacity 0.3s, transform 0.3s;
        }
        .chatbot-toggle:hover {
            transform: scale(1.1);
        }
        .chatbot-toggle.open {
            opacity: 0.7;
        }
        .chatbot-toggle i {
            font-size: 1.5rem;
            color: #e2e8f0;
        }
        .btn-primary, .btn-danger, .btn-success {
            border-radius: 8px;
            transition: transform 0.3s, background 0.3s;
        }
        .btn-primary {
            background: linear-gradient(45deg, #a78bfa, #7c3aed);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #7c3aed, #a78bfa);
            transform: scale(1.05);
        }
        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #f87171);
            border: none;
        }
        .btn-danger:hover {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            transform: scale(1.05);
        }
        .btn-success {
            background: linear-gradient(45deg, #22c55e, #4ade80);
            border: none;
        }
        .btn-success:hover {
            background: linear-gradient(45deg, #16a34a, #22c55e);
            transform: scale(1.05);
        }
        footer {
            background: rgba(30, 10, 60, 0.7);
            backdrop-filter: blur(12px);
            color: #e2e8f0;
            text-align: center;
            padding: 8px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
        }
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #e2e8f0;
            border-radius: 8px;
        }
        .form-control::placeholder {
            color: #94a3b8;
        }
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            min-height: 300px;
            overflow: visible;
            position: relative;
        }
        .chart-container .empty-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #94a3b8;
            font-size: 1.2rem;
            text-align: center;
        }
        .profile-card {
            background: linear-gradient(45deg, #a78bfa, #7c3aed);
            border: none;
            color: #fff;
        }
        .profile-card h5 {
            color: #fff;
        }
        .progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }
        .progress-bar {
            background: linear-gradient(45deg, #facc15, #f97316);
        }
        .badge-icon {
            font-size: 2rem;
            margin: 0.5rem;
            animation: bounce 1s infinite;
        }
        .quote-card {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #facc15;
            font-style: italic;
        }
        .stat-card {
            cursor: pointer;
            transition: background 0.3s;
        }
        .stat-card:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .insights-card {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #facc15;
        }
        .insights-card ul li::before {
            content: '★';
            color: #facc15;
            margin-right: 8px;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 100px;
                padding: 15px;
            }
            .timer {
                font-size: 1.3rem;
            }
            .session-timer {
                top: 60px;
                right: 10px;
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            .chatbot-panel {
                width: 250px;
                right: -250px;
                height: calc(100vh - 120px);
            }
            .chatbot-panel.open {
                right: 0;
            }
            .chatbot-toggle {
                bottom: 60px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
            .chatbot-toggle i {
                font-size: 1.2rem;
            }
            .chatbot-suggestion {
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            .chatbot-header h5 {
                font-size: 1rem;
            }
            .chatbot-message {
                font-size: 0.85rem;
            }
            .card h5 {
                font-size: 1.1rem;
            }
            .chart-container {
                padding: 15px;
                min-height: 200px;
            }
            .badge-icon {
                font-size: 1.5rem;
            }
            .stat-card {
                font-size: 0.9rem;
            }
            .insights-card {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">StudyBuddy</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="routine.html">Routine</a></li>
                    <li class="nav-item"><a class="nav-link" href="mission.html">Mission Board</a></li>
                    <li class="nav-item"><a class="nav-link" href="exam-recap.html">Exam Recap</a></li>
                    <li class="nav-item"><a class="nav-link active" href="progress.html">Progress</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Session Timer -->
    <div id="sessionTimer" class="session-timer green">
        <i class="fas fa-clock me-2"></i>
        <span id="countdownTimer">No active session</span>
    </div>

    <!-- Chatbot Toggle -->
    <div class="chatbot-toggle" id="chatbotToggle">
        <i class="fas fa-robot"></i>
    </div>

    <!-- Chatbot Panel -->
    <div class="chatbot-panel" id="chatbotPanel">
        <div class="chatbot-header">
            <h5>StudyBuddy Assistant</h5>
            <div>
                <button class="clear-btn" id="clearChatBtn"><i class="fas fa-trash"></i></button>
                <button class="close-btn" id="closeChatBtn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="chatbot-body" id="chatbotMessages">
            <div class="chatbot-message">
                Welcome to StudyBuddy! Track your progress, earn stars, and unlock achievements. Try the suggestions below or ask me anything!
            </div>
        </div>
        <div class="chatbot-suggestions">
            <button class="chatbot-suggestion" data-query="gamification">How does gamification work?</button>
            <button class="chatbot-suggestion" data-query="analytics">What analytics are shown?</button>
            <button class="chatbot-suggestion" data-query="daily reading">How is daily reading tracked?</button>
            <button class="chatbot-suggestion" data-query="insights">What are insights?</button>
            <button class="chatbot-suggestion" data-query="goals">How do I set goals?</button>
        </div>
        <div class="chatbot-footer">
            <form id="chatbotForm">
                <div class="input-group">
                    <input type="text" id="chatbotInput" class="form-control" placeholder="Ask me something..." autocomplete="off">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <h1 class="text-center mb-5" style="font-weight: 700; letter-spacing: 1px; color: #60a5fa;">Your Progress</h1>
        <div class="row">
            <!-- Profile Card -->
            <div class="col-md-4 mb-4">
                <div class="card profile-card">
                    <div class="card-body">
                        <h5><i class="fas fa-user-graduate me-2"></i>Your Profile</h5>
                        <p><strong>Level:</strong> <span id="userLevel">1</span></p>
                        <p><strong>Stars:</strong> <span id="userStars">0</span> <i class="fas fa-star text-warning"></i></p>
                        <div class="progress mb-3">
                            <div id="levelProgress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p><strong>Achievements:</strong></p>
                        <div id="achievements" class="d-flex flex-wrap justify-content-center"></div>
                        <button class="btn btn-success w-100 mt-3" onclick="redeemReward()">Redeem Stars</button>
                    </div>
                </div>
                <div class="card quote-card mt-4">
                    <div class="card-body">
                        <p id="motivationalQuote">"The only way to do great work is to love what you do." - Steve Jobs</p>
                    </div>
                </div>
            </div>
            <!-- Analytics -->
            <div class="col-md-8 mb-4">
                <!-- Insights Card -->
                <div class="card insights-card mb-4">
                    <div class="card-body">
                        <h5><i class="fas fa-lightbulb me-2"></i>Your Insights</h5>
                        <ul id="insightsList" style="list-style: none; padding-left: 0;"></ul>
                    </div>
                </div>
                <!-- Stats and Charts -->
                <div class="card">
                    <div class="card-body">
                        <h5><i class="fas fa-chart-bar me-2"></i>Analytics Dashboard</h5>
                        <div class="row mb-4">
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card stat-card text-center" onclick="showStudyDetails()" data-bs-toggle="tooltip" title="Click for details">
                                    <div class="card-body">
                                        <p><i class="fas fa-clock fa-2x text-warning"></i></p>
                                        <p><strong>Total Study Hours</strong></p>
                                        <p id="totalStudyHours">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card stat-card text-center" onclick="showExamDetails()" data-bs-toggle="tooltip" title="Click for details">
                                    <div class="card-body">
                                        <p><i class="fas fa-file-alt fa-2x text-primary"></i></p>
                                        <p><strong>Average Score</strong></p>
                                        <p id="averageScore">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card stat-card text-center" onclick="showExamDetails()" data-bs-toggle="tooltip" title="Click for details">
                                    <div class="card-body">
                                        <p><i class="fas fa-check-circle fa-2x text-success"></i></p>
                                        <p><strong>Pass Rate</strong></p>
                                        <p id="passRate">0%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card stat-card text-center" data-bs-toggle="tooltip" title="Days studied in a row">
                                    <div class="card-body">
                                        <p><i class="fas fa-fire fa-2x text-danger"></i></p>
                                        <p><strong>Streak</strong></p>
                                        <p id="streakDays">0 days</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-bar me-2"></i>Daily Reading Time</h5>
                            <select id="dailySubject" class="form-select mb-3" style="width: auto;">
                                <option value="">All Subjects</option>
                            </select>
                            <canvas id="dailyReadingChart"></canvas>
                            <div class="empty-message" id="dailyReadingEmpty" style="display: none;">No study sessions recorded for this period.</div>
                        </div>
                        <div class="chart-container mt-4">
                            <h5><i class="fas fa-chart-bar me-2"></i>Study Time</h5>
                            <select id="studyPeriod" class="form-select mb-3" style="width: auto;">
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                            <canvas id="studyTimeChart"></canvas>
                            <div class="empty-message" id="studyTimeEmpty" style="display: none;">No study sessions recorded for this period.</div>
                        </div>
                        <div class="chart-container mt-4">
                            <h5><i class="fas fa-chart-line me-2"></i>Exam Score Trend</h5>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <select id="examSubject" class="form-select" style="width: auto;">
                                    <option value="">All Subjects</option>
                                </select>
                                <select id="examPeriod" class="form-select" style="width: auto;">
                                    <option value="all">All Time</option>
                                    <option value="weekly">Last Week</option>
                                    <option value="monthly">Last Month</option>
                                </select>
                            </div>
                            <canvas id="scoreChart"></canvas>
                            <div class="empty-message" id="scoreChartEmpty" style="display: none;">No exams recorded for this period.</div>
                        </div>
                        <div class="chart-container mt-4">
                            <h5><i class="fas fa-chart-pie me-2"></i>Study Time by Subject</h5>
                            <canvas id="subjectPieChart"></canvas>
                            <div class="empty-message" id="subjectPieEmpty" style="display: none;">No study sessions recorded.</div>
                        </div>
                    </div>
                </div>
                <!-- Goal Tracker -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h5><i class="fas fa-bullseye me-2"></i>Goal Tracker</h5>
                        <form id="addGoalForm" class="mb-3">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <select id="goalType" class="form-control" required data-bs-toggle="tooltip" title="Select goal type">
                                        <option value="">Select Type</option>
                                        <option value="study">Study Hours</option>
                                        <option value="exam">Exam Score</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <input type="text" id="goalSubject" class="form-control" placeholder="Subject (e.g., Math)" data-bs-toggle="tooltip" title="Enter subject or leave blank for general goal">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <input type="number" id="goalValue" class="form-control" placeholder="Value (e.g., 10 hours or 85)" required data-bs-toggle="tooltip" title="Enter target value">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Goal</button>
                        </form>
                        <div id="goalList"></div>
                    </div>
                </div>
                <!-- Leaderboard -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h5><i class="fas fa-trophy me-2"></i>Leaderboard (Top 5)</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>User</th>
                                    <th>Level</th>
                                    <th>Stars</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>© 2025 Urfa Hasan Fattah. All rights reserved.</p>
    </footer>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <script>
        // LocalStorage Management
        function loadRoutine() {
            return JSON.parse(localStorage.getItem('studyRoutine')) || {
                Sunday: [], Monday: [], Tuesday: [], Wednesday: [], Thursday: [], Friday: [], Saturday: []
            };
        }

        function loadExams() {
            return JSON.parse(localStorage.getItem('examRecaps')) || [];
        }

        function loadGamification() {
            return JSON.parse(localStorage.getItem('gamification')) || {
                stars: 0,
                level: 1,
                hours: 0,
                achievements: [],
                rewards: [],
                lastStudyDate: null,
                streak: 0
            };
        }

        function saveGamification(data) {
            localStorage.setItem('gamification', JSON.stringify(data));
        }

        function loadGoals() {
            return JSON.parse(localStorage.getItem('goals')) || [];
        }

        function saveGoals(goals) {
            localStorage.setItem('goals', JSON.stringify(goals));
        }

        // Format Date to MM/DD/YYYY
        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return 'Invalid Date';
                return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
            } catch (e) {
                console.error('Error formatting date:', e);
                return 'Invalid Date';
            }
        }

        // Session Timer
        function updateSessionTimer() {
            const now = new Date();
            now.setTime(now.getTime() + (6 * 60 * 60 * 1000)); // Adjust for +06 timezone
            const currentDate = formatDate(now);
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM
            const routine = loadRoutine();
            const timerElement = document.getElementById('sessionTimer');
            const countdownElement = document.getElementById('countdownTimer');

            // Find active session
            let currentSession = null;
            Object.keys(routine).forEach(day => {
                routine[day].forEach(session => {
                    if (session.date === currentDate && currentTime >= session.startTime && currentTime < session.endTime) {
                        currentSession = session;
                    }
                });
            });

            if (currentSession) {
                const [hours, minutes] = currentSession.endTime.split(':').map(Number);
                const endTime = new Date(now);
                endTime.setHours(hours, minutes, 0, 0);
                const timeLeft = endTime - now;
                if (timeLeft > 0) {
                    const totalMinutes = ((hours * 60 + minutes) - (now.getHours() * 60 + now.getMinutes()));
                    const percentLeft = (timeLeft / (totalMinutes * 60 * 1000)) * 100;
                    const minutesLeft = Math.floor(timeLeft / 1000 / 60);
                    const secondsLeft = Math.floor((timeLeft / 1000) % 60);
                    countdownElement.textContent = `${currentSession.subject}: ${minutesLeft}m ${secondsLeft}s left`;
                    timerElement.className = `session-timer ${
                        percentLeft > 50 ? 'green' : percentLeft > 20 ? 'yellow' : 'red'
                    }`;
                    updateGamification(currentSession);
                } else {
                    countdownElement.textContent = 'Session ended';
                    timerElement.className = 'session-timer green';
                }
            } else {
                countdownElement.textContent = 'No active session';
                timerElement.className = 'session-timer green';
            }
        }

        // Gamification Logic
        function updateGamification(session) {
            const gamification = loadGamification();
            const now = new Date();
            now.setTime(now.getTime() + (6 * 60 * 60 * 1000));
            const today = formatDate(now);
            const [startH, startM] = session.startTime.split(':').map(Number);
            const [endH, endM] = session.endTime.split(':').map(Number);
            const hours = (endH * 60 + endM - (startH * 60 + startM)) / 60;

            // Update only if session is new (avoid double-counting)
            if (session.date === today && !session.counted) {
                gamification.hours += hours;
                gamification.stars += Math.floor(hours);
                gamification.level = Math.floor(gamification.hours / 5) + 1;
                session.counted = true; // Mark session as counted
                saveRoutine(loadRoutine()); // Update routine with counted flag

                // Update streak
                const lastDate = gamification.lastStudyDate ? new Date(gamification.lastStudyDate) : null;
                if (!lastDate || (new Date(today) - new Date(gamification.lastStudyDate)) / (1000 * 60 * 60 * 24) === 1) {
                    gamification.streak++;
                } else if (lastDate && new Date(today).getDate() !== lastDate.getDate()) {
                    gamification.streak = 1;
                }
                gamification.lastStudyDate = today;

                // Check achievements
                const exams = loadExams();
                const achievements = [
                    { id: 'math_master', name: 'Math Master', icon: 'fas fa-calculator', condition: () => exams.filter(e => e.subject === 'Math' && e.score >= 80).length >= 5 },
                    { id: 'streak_star', name: 'Streak Star', icon: 'fas fa-fire', condition: () => gamification.streak >= 7 },
                    { id: 'study_guru', name: 'Study Guru', icon: 'fas fa-book', condition: () => gamification.hours >= 50 }
                ];
                achievements.forEach(ach => {
                    if (!gamification.achievements.includes(ach.id) && ach.condition()) {
                        gamification.achievements.push(ach.id);
                        triggerConfetti();
                        alert(`Achievement Unlocked: ${ach.name}!`);
                    }
                });

                saveGamification(gamification);
                updateProfile();
                updateInsights();
            }
        }

        // Redeem Rewards
        function redeemReward() {
            const gamification = loadGamification();
            const rewards = [
                { id: 'theme_purple', name: 'Purple Theme', cost: 10, apply: () => document.body.style.background = 'linear-gradient(135deg, #4c1d95, #7e22ce)' },
                { id: 'emoji_star', name: 'Star Emoji', cost: 5, apply: () => alert('Star emoji added to chatbot!') }
            ];
            const choice = prompt(`Available Rewards:\n${rewards.map(r => `${r.name} (${r.cost} stars)`).join('\n')}\nEnter reward ID (e.g., theme_purple):`);
            const reward = rewards.find(r => r.id === choice);
            if (reward && gamification.stars >= reward.cost) {
                gamification.stars -= reward.cost;
                gamification.rewards.push(reward.id);
                reward.apply();
                saveGamification(gamification);
                updateProfile();
                triggerConfetti();
                alert(`Reward Redeemed: ${reward.name}!`);
            } else {
                alert('Invalid reward or insufficient stars.');
            }
        }

        // Update Profile
        function updateProfile() {
            const gamification = loadGamification();
            const routine = loadRoutine();
            const totalHours = Object.values(routine).flat().reduce((sum, session) => {
                const [startH, startM] = session.startTime.split(':').map(Number);
                const [endH, endM] = session.endTime.split(':').map(Number);
                return sum + (endH * 60 + endM - (startH * 60 + startM)) / 60;
            }, 0);

            // Sync gamification hours
            gamification.hours = totalHours;
            gamification.stars = Math.floor(totalHours);
            gamification.level = Math.floor(totalHours / 5) + 1;
            saveGamification(gamification);

            document.getElementById('userLevel').textContent = gamification.level;
            document.getElementById('userStars').textContent = gamification.stars;
            const progress = (gamification.hours % 5) / 5 * 100;
            const progressBar = document.getElementById('levelProgress');
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            const achievements = [
                { id: 'math_master', name: 'Math Master', icon: 'fas fa-calculator' },
                { id: 'streak_star', name: 'Streak Star', icon: 'fas fa-fire' },
                { id: 'study_guru', name: 'Study Guru', icon: 'fas fa-book' }
            ];
            const achievementsDiv = document.getElementById('achievements');
            achievementsDiv.innerHTML = gamification.achievements.map(id => {
                const ach = achievements.find(a => a.id === id);
                return `<i class="${ach.icon} badge-icon" data-bs-toggle="tooltip" title="${ach.name}"></i>`;
            }).join('');

            document.getElementById('streakDays').textContent = `${gamification.streak} days`;
            initTooltips();
        }

        // Motivational Quote
        function updateQuote() {
            const quotes = [
                "The only way to do great work is to love what you do. - Steve Jobs",
                "Success is not final, failure is not fatal. - Winston Churchill",
                "You don’t have to be great to start, but you have to start to be great. - Zig Ziglar"
            ];
            const quote = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('motivationalQuote').textContent = quote;
        }

        // Personalized Insights
        function updateInsights() {
            const exams = loadExams();
            const routine = loadRoutine();
            const gamification = loadGamification();
            const insights = [];

            // Exam score trend
            const recentExams = exams.slice(-3);
            if (recentExams.length >= 2) {
                const scores = recentExams.map(e => e.score);
                const improving = scores[scores.length - 1] > scores[0];
                if (improving) {
                    insights.push('Your exam scores are trending upward! Keep up the momentum.');
                } else if (scores[scores.length - 1] < 60) {
                    insights.push('Your recent exam score is low. Try reviewing notes in Exam Recap.');
                }
            }

            // Study habits
            const weeklyHours = Object.values(routine).flat().reduce((sum, session) => {
                const [startH, startM] = session.startTime.split(':').map(Number);
                const [endH, endM] = session.endTime.split(':').map(Number);
                return sum + (endH * 60 + endM - (startH * 60 + startM)) / 60;
            }, 0);
            if (weeklyHours < 5) {
                insights.push('Study time is low this week. Add more sessions in Routine to boost hours!');
            } else if (weeklyHours > 15) {
                insights.push('Amazing! You’re logging serious study hours. Aim for consistency.');
            }

            // Streak
            if (gamification.streak >= 5) {
                insights.push('Great job maintaining a study streak! Keep it going for more stars.');
            }

            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = insights.length ? insights.map(i => `<li>${i}</li>`).join('') : '<li>No insights yet. Keep studying to get personalized tips!</li>';
        }

        // Daily Reading Time Chart
        let dailyReadingChart = null;
        function updateDailyReadingChart() {
            const routine = loadRoutine();
            const subject = document.getElementById('dailySubject').value;
            const now = new Date();
            now.setTime(now.getTime() + (6 * 60 * 60 * 1000));
            const labels = [];
            const hours = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const dateStr = formatDate(date);
                labels.push(dateStr);
                const day = date.toLocaleDateString('en-US', { weekday: 'long' });
                const sessions = routine[day]?.filter(s => (!subject || s.subject === subject) && s.date === dateStr) || [];
                const dailyHours = sessions.reduce((sum, session) => {
                    const [startH, startM] = session.startTime.split(':').map(Number);
                    const [endH, endM] = session.endTime.split(':').map(Number);
                    return sum + (endH * 60 + endM - (startH * 60 + startM)) / 60;
                }, 0);
                hours.push(dailyHours);
            }

            const emptyMessage = document.getElementById('dailyReadingEmpty');
            emptyMessage.style.display = hours.every(h => h === 0) ? 'block' : 'none';

            if (dailyReadingChart) dailyReadingChart.destroy();
            const ctx = document.getElementById('dailyReadingChart').getContext('2d');
            dailyReadingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Daily Study Hours',
                        data: hours,
                        backgroundColor: '#60a5fa',
                        borderColor: '#facc15',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Hours', color: '#e2e8f0' }, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { title: { display: true, text: 'Date', color: '#e2e8f0' }, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        tooltip: { backgroundColor: 'rgba(30, 10, 60, 0.8)', titleColor: '#e2e8f0', bodyColor: '#e2e8f0' }
                    },
                    onClick: (e, elements) => {
                        if (elements.length) {
                            const index = elements[0].index;
                            const date = labels[index];
                            const day = new Date(date).toLocaleDateString('en-US', { weekday: 'long' });
                            const sessions = routine[day]?.filter(s => (!subject || s.subject === subject) && s.date === date) || [];
                            alert(`Sessions on ${date}:\n${sessions.length ? sessions.map(s => `${s.subject}: ${s.startTime}-${s.endTime}`).join('\n') : 'No sessions'}`);
                        }
                    }
                }
            });
        }

        // Study Time Chart
        let studyTimeChart = null;
        function updateStudyTimeChart() {
            const routine = loadRoutine();
            const period = document.getElementById('studyPeriod').value;
            let labels = [], hours = [];

            if (period === 'weekly') {
                labels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                hours = labels.map((_, i) => {
                    const day = Object.keys(routine)[i] || labels[i];
                    const sessions = routine[day] || [];
                    return sessions.reduce((sum, session) => {
                        const [startH, startM] = session.startTime.split(':').map(Number);
                        const [endH, endM] = session.endTime.split(':').map(Number);
                        return sum + (endH * 60 + endM - (startH * 60 + startM)) / 60;
                    }, 0);
                });
            } else {
                labels = Array.from({ length: 4 }, (_, i) => `Week ${i + 1}`);
                hours = labels.map(() => Object.values(routine).flat().reduce((sum, session) => {
                    const [startH, startM] = session.startTime.split(':').map(Number);
                    const [endH, endM] = session.endTime.split(':').map(Number);
                    return sum + (endH * 60 + endM - (startH * 60 + startM)) / 60;
                }, 0) / 4);
            }

            const emptyMessage = document.getElementById('studyTimeEmpty');
            emptyMessage.style.display = hours.every(h => h === 0) ? 'block' : 'none';

            if (studyTimeChart) studyTimeChart.destroy();
            const ctx = document.getElementById('studyTimeChart').getContext('2d');
            studyTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Study Hours',
                        data: hours,
                        backgroundColor: '#60a5fa',
                        borderColor: '#facc15',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Hours', color: '#e2e8f0' }, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { title: { display: true, text: period === 'weekly' ? 'Day' : 'Week', color: '#e2e8f0' }, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        tooltip: { backgroundColor: 'rgba(30, 10, 60, 0.8)', titleColor: '#e2e8f0', bodyColor: '#e2e8f0' }
                    },
                    onClick: (e, elements) => {
                        if (elements.length && period === 'weekly') {
                            const index = elements[0].index;
                            const day = labels[index];
                            const sessions = routine[day] || [];
                            alert(`Sessions on ${day}:\n${sessions.length ? sessions.map(s => `${s.subject}: ${s.startTime}-${s.endTime}`).join('\n') : 'No sessions'}`);
                        }
                    }
                }
            });
        }

        // Exam Score Chart
        let scoreChart = null;
        function updateScoreChart() {
            const exams = loadExams();
            const subject = document.getElementById('examSubject').value;
            const period = document.getElementById('examPeriod').value;
            const now = new Date();
            now.setTime(now.getTime() + (6 * 60 * 60 * 1000));
            let filteredExams = subject ? exams.filter(exam => exam.subject === subject) : exams;

            if (period === 'weekly') {
                filteredExams = filteredExams.filter(exam => new Date(exam.date) >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000));
            } else if (period === 'monthly') {
                filteredExams = filteredExams.filter(exam => new Date(exam.date) >= new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000));
            }

            filteredExams.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = filteredExams.map(exam => formatDate(exam.date));
            const scores = filteredExams.map(exam => exam.score);

            const emptyMessage = document.getElementById('scoreChartEmpty');
            emptyMessage.style.display = filteredExams.length === 0 ? 'block' : 'none';

            if (scoreChart) scoreChart.destroy();
            const ctx = document.getElementById('scoreChart').getContext('2d');
            scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Exam Scores',
                        data: scores,
                        borderColor: '#60a5fa',
                        backgroundColor: '#facc15',
                        pointBackgroundColor: '#facc15',
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score', color: '#e2e8f0' }, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { title: { display: true, text: 'Date', color: '#e2e8f0' }, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        tooltip: { backgroundColor: 'rgba(30, 10, 60, 0.8)', titleColor: '#e2e8f0', bodyColor: '#e2e8f0' }
                    },
                    onClick: (e, elements) => {
                        if (elements.length) {
                            const index = elements[0].index;
                            const exam = filteredExams[index];
                            alert(`Exam on ${formatDate(exam.date)}: ${exam.subject}, Score: ${exam.score}, Notes: ${exam.notes || 'None'}`);
                        }
                    }
                }
            });
        }

        // Subject Pie Chart
        let subjectPieChart = null;
        function updateSubjectPieChart() {
            const routine = loadRoutine();
            const subjects = {};
            Object.values(routine).flat().forEach(session => {
                subjects[session.subject] = (subjects[session.subject] || 0) + (
                    (parseInt(session.endTime.split(':')[0]) * 60 + parseInt(session.endTime.split(':')[1])) -
                    (parseInt(session.startTime.split(':')[0]) * 60 + parseInt(session.startTime.split(':')[1])
                ) / 60;
            });

            const labels = Object.keys(subjects);
            const data = Object.values(subjects);
            const colors = ['#60a5fa', '#facc15', '#22c55e', '#ef4444', '#a78bfa'];

            const emptyMessage = document.getElementById('subjectPieEmpty');
            emptyMessage.style.display = labels.length === 0 ? 'block' : 'none';

            if (subjectPieChart) subjectPieChart.destroy();
            const ctx = document.getElementById('subjectPieChart').getContext('2d');
            subjectPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: colors }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e2e8f0' } },
                        tooltip: { backgroundColor: 'rgba(30, 10, 60, 0.8)', titleColor: '#e2e8f0', bodyColor: '#e2e8f0' }
                    }
                }
            });
        }

        // Update Subject Filters
        function updateSubjectFilters() {
            try {
                const exams = loadExams();
                const routine = loadRoutine();
                const subjects = [...new Set([...exams.map(exam => exam.subject), ...Object.values(routine).flat().map(s => s.subject)])];
                const examSelect = document.getElementById('examSubject');
                const dailySelect = document.getElementById('dailySubject');
                examSelect.innerHTML = dailySelect.innerHTML = '<option value="">All Subjects</option>';
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    examSelect.appendChild(option.cloneNode(true));
                    dailySelect.appendChild(option);
                });
            } catch (e) {
                console.error('Error updating subject filters:', e);
            }
        }

        // Update Stats
        function updateStats() {
            try {
                const routine = loadRoutine();
                const exams = loadExams();
                const totalHours = Object.values(routine).flat().reduce((sum, session) => {
                    const [startH, startM] = session.startTime.split(':').map(Number);
                    const [endH, endM] = session.endTime.split(':').map(Number);
                    return sum + (endH * 60 + endM - (startH * 60 + startM)) / 60;
                }, 0);
                const averageScore = exams.length ? (exams.reduce((sum, exam) => sum + exam.score, 0) / exams.length).toFixed(1) : 0;
                const passRate = exams.length ? ((exams.filter(exam => exam.score >= 60).length / exams.length) * 100).toFixed(1) : 0;

                document.getElementById('totalStudyHours').textContent = totalHours.toFixed(1);
                document.getElementById('averageScore').textContent = averageScore;
                document.getElementById('passRate').textContent = `${passRate}%`;
            } catch (e) {
                console.error('Error updating stats:', e);
            }
        }

        // Goal Tracker
        function updateGoals() {
            try {
                const goals = loadGoals();
                const goalList = document.getElementById('goalList');
                goalList.innerHTML = '';
                goals.forEach((goal, index) => {
                    const progress = calculateGoalProgress(goal);
                    const div = document.createElement('div');
                    div.className = 'mb-3';
                    div.innerHTML = `
                        <p><strong>${goal.type === 'study' ? 'Study Hours' : 'Exam Score'} (${goal.subject || 'General'})</strong>: ${goal.value}${goal.type === 'study' ? ' hours' : ''}</p>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: ${progress}%;" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">${progress}%</div>
                        </div>
                        <button class="btn btn-danger btn-sm mt-2" onclick="deleteGoal(${index})">Delete</button>
                    `;
                    goalList.appendChild(div);
                });
            } catch (e) {
                console.error('Error updating goals:', e);
            }
        }

        function calculateGoalProgress(goal) {
            try {
                if (goal.type === 'study') {
                    const routine = loadRoutine();
                    const hours = Object.values(routine).flat().filter(s => !goal.subject || s.subject === goal.subject).reduce((sum, session) => {
                        const [startH, startM] = session.startTime.split(':').map(Number);
                        const [endH, endM] = session.endTime.split(':').map(Number);
                        return sum + (endH * 60 + endM - (startH * 60 + startM)) / 60;
                    }, 0);
                    return Math.min((hours / goal.value) * 100, 100);
                } else {
                    const exams = loadExams();
                    const latestScore = exams.filter(e => !goal.subject || e.subject === goal.subject).slice(-1)[0]?.score || 0;
                    return Math.min((latestScore / goal.value) * 100, 100);
                }
            } catch (e) {
                console.error('Error calculating goal progress:', e);
                return 0;
            }
        }

        function deleteGoal(index) {
            try {
                const goals = loadGoals();
                goals.splice(index, 1);
                saveGoals(goals);
                updateGoals();
            } catch (e) {
                console.error('Error deleting goal:', e);
            }
        }

        document.getElementById('addGoalForm').addEventListener('submit', (e) => {
            e.preventDefault();
            try {
                const type = document.getElementById('goalType').value;
                const subject = document.getElementById('goalSubject').value.trim();
                const value = parseFloat(document.getElementById('goalValue').value);
                if (!type || isNaN(value) || value <= 0) {
                    alert('Please fill in valid goal details.');
                    return;
                }
                const goals = loadGoals();
                goals.push({ type, subject: subject || null, value });
                saveGoals(goals);
                updateGoals();
                e.target.reset();
            } catch (e) {
                console.error('Error adding goal:', e);
            }
        });

        // Leaderboard
        function updateLeaderboard() {
            try {
                const gamification = loadGamification();
                const mockUsers = [
                    { name: 'User123', level: 10, stars: 50 },
                    { name: 'StudyAce', level: 8, stars: 40 },
                    { name: 'Brainy', level: 6, stars: 30 },
                    { name: 'ScholarX', level: 4, stars: 20 },
                    { name: 'You', level: gamification.level, stars: gamification.stars }
                ];
                mockUsers.sort((a, b) => b.stars - a.stars);
                const tbody = document.getElementById('leaderboard');
                tbody.innerHTML = mockUsers.slice(0, 5).map((user, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.level}</td>
                        <td>${user.stars} <i class="fas fa-star text-warning"></i></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error updating leaderboard:', e);
            }
        }

        // Confetti Animation
        function triggerConfetti() {
            try {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            } catch (e) {
                console.error('Error triggering confetti:', e);
            }
        }

        // Details Drill-Down
        function showStudyDetails() {
            alert('Study Details: View your study sessions in the Routine page!');
        }

        function showExamDetails() {
            alert('Exam Details: Check your scores in the Exam Recap page!');
        }

        // Chatbot
        const chatbotResponses = {
            'gamification': 'Earn 1 star per study hour and level up every 5 hours! Unlock achievements like "Math Master" and redeem stars for rewards like themes.',
            'analytics': 'The dashboard shows total study hours, average exam score, pass rate, and streak. Charts track daily reading, study time, exam scores, and subject breakdown!',
            'daily reading': 'The Daily Reading Time chart shows study hours for the past 7 days. Filter by subject and click bars to see session details!',
            'insights': 'Insights analyze your study habits and exam trends to give personalized tips, like studying more on weekends or reviewing low scores.',
            'goals': 'Set study or exam goals (e.g., 10 hours in Math or score 85). Add them via the Goal Tracker and monitor progress with bars!',
            'hi': 'Hello! Welcome to StudyBuddy’s Progress page. Track your journey, earn rewards, and stay motivated. Try the suggestions below!'
        };

        function toggleChatbot() {
            try {
                const panel = document.getElementById('chatbotPanel');
                const toggle = document.getElementById('chatbotToggle');
                panel.classList.toggle('open');
                toggle.classList.toggle('open');
                if (panel.classList.contains('open')) {
                    document.getElementById('chatbotInput').focus();
                }
            } catch (e) {
                console.error('Error toggling chatbot:', e);
            }
        }

        function closeChatbot() {
            try {
                const panel = document.getElementById('chatbotPanel');
                const toggle = document.getElementById('chatbotToggle');
                panel.classList.remove('open');
                toggle.classList.remove('open');
            } catch (e) {
                console.error('Error closing chatbot:', e);
            }
        }

        function clearChat() {
            try {
                const messages = document.getElementById('chatbotMessages');
                messages.innerHTML = `
                    <div class="chatbot-message">
                        Welcome to StudyBuddy! Track your progress, earn stars, and unlock achievements. Try the suggestions below or ask me anything!
                    </div>
                `;
                messages.scrollTop = messages.scrollHeight;
            } catch (e) {
                console.error('Error clearing chat:', e);
            }
        }

        function addChatMessage(message, isUser = false) {
            try {
                const messages = document.getElementById('chatbotMessages');
                const div = document.createElement('div');
                div.className = `chatbot-message ${isUser ? 'user' : ''}`;
                div.textContent = message;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            } catch (e) {
                console.error('Error adding chat message:', e);
            }
        }

        function sendSuggestion(query) {
            try {
                const input = document.getElementById('chatbotInput');
                input.value = query;
                const event = new Event('submit');
                document.getElementById('chatbotForm').dispatchEvent(event);
            } catch (e) {
                console.error('Error sending suggestion:', e);
            }
        }

        function initializeChatbot() {
            try {
                document.getElementById('chatbotToggle').addEventListener('click', toggleChatbot);
                document.getElementById('closeChatBtn').addEventListener('click', closeChatbot);
                document.getElementById('clearChatBtn').addEventListener('click', clearChat);
                document.getElementById('chatbotForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = document.getElementById('chatbotInput');
                    const query = input.value.trim().toLowerCase();
                    if (!query) return;

                    addChatMessage(query, true);
                    const response = chatbotResponses[query] || 'Sorry, I didn’t understand that. Try the suggestions below or ask about "daily reading" or "insights"!';
                    setTimeout(() => addChatMessage(response), 500);
                    input.value = '';
                });

                document.querySelectorAll('.chatbot-suggestion').forEach(button => {
                    button.addEventListener('click', () => sendSuggestion(button.dataset.query));
                });

                document.addEventListener('click', (e) => {
                    const panel = document.getElementById('chatbotPanel');
                    const toggle = document.getElementById('chatbotToggle');
                    if (panel.classList.contains('open') && !panel.contains(e.target) && !toggle.contains(e.target)) {
                        closeChatbot();
                    }
                });
            } catch (e) {
                console.error('Error initializing chatbot:', e);
            }
        }

        // Initialize Tooltips
        function initTooltips() {
            try {
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltipTriggerList.forEach(tooltipTriggerEl => {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });
            } catch (e) {
                console.error('Error initializing tooltips:', e);
            }
        }

        // Initialize
        function initialize() {
            try {
                console.log('Initializing Progress Page...');
                updateSessionTimer();
                updateProfile();
                updateQuote();
                updateSubjectFilters();
                updateStats();
                updateDailyReadingChart();
                updateStudyTimeChart();
                updateScoreChart();
                updateSubjectPieChart();
                updateGoals();
                updateLeaderboard();
                updateInsights();
                initializeChatbot();
                initTooltips();
                setInterval(updateSessionTimer, 1000);
                document.getElementById('dailySubject').addEventListener('change', updateDailyReadingChart);
                document.getElementById('studyPeriod').addEventListener('change', updateStudyTimeChart);
                document.getElementById('examSubject').addEventListener('change', updateScoreChart);
                document.getElementById('examPeriod').addEventListener('change', updateScoreChart);
                console.log('Initialization complete.');
            } catch (e) {
                console.error('Error during initialization:', e);
            }
        }

        // Run initialization
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>